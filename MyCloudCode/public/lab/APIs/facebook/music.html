<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Get home feed</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="John Tubert">
	<!-- Date: 2011-02-28 -->
	
	<script src="js/jquery-1.4.4-min.js"></script>
	<script src="http://connect.facebook.net/en_US/all.js"></script>	
</head>
<body>
	
	<div id="fb-root"></div>
<script>

	Array.prototype.pushUnique = function (item){
	    if(this.indexOf(item) == -1) {    
	        this.push(item);
	        return true;
	    }
	    return false;
	}

	window.fbAsyncInit = function() {
     	FB.init({appId: "313518962064403", status: true, cookie: true, xfbml: true});

     	function updateButton(response) {
	        button       =   document.getElementById('fb-auth');	        
	        
	        if (response.authResponse) {
	            //user is already logged in and connected
	            FB.api('/me', function(info) {
	                getFriendsMusic();
	            });
	            
	            button.onclick = function() {
	                FB.logout(function(response) {
	                    //logout(response);
	                });
	            };
	        } else {
	            //user is not connected to your app or logged out
	            button.innerHTML = 'Login';
	            button.onclick = function() {
	                
					//console.log("login");
					
	                FB.login(function(response) {
	                    if (response.authResponse) {
	                        FB.api('/me', function(info) {
	                            getFriendsMusic();
	                        });	   
	                    } else {
	                        //user cancelled login or did not grant authorization
	                        
	                    }
	                }, {scope:'read_stream,friends_actions.music,user_actions.music'});  	
	            }
	        }
	    }
	    
	    // run once with current status and whenever the status changes
	    FB.getLoginStatus(updateButton);
	    FB.Event.subscribe('auth.statusChange', updateButton);	
	};	    
	
	
	function getFriendsMusic(){
		button.innerHTML = 'Logout';

		var results = new Array();

		var results2 = new Array();




		var params = {limit:100};	
		FB.api('/me/friends', 'get', params, function(response) {
		  if (!response || response.error) {
		    alert('Error occured');
		  } else {
		  	//console.log(response.data[i]);
		    for (var i = response.data.length - 1; i >= 0; i--) {



		    	//console.log(response.data[i].name);
		    	//if(response.data[i].id == "513794405"){
		    		var params = {limit:100};		
					FB.api('/'+response.data[i].id+'/music.listens', 'get', params, function(responseMusic) {

						
					  if (!responseMusic || responseMusic.error) {
					    console.log('Error occured: ',responseMusic.error);
					  } else {
					  	if(responseMusic.data.length > 0){
					  		
					  		//$("#album").append("<b>"+responseMusic.data[0].from.name+"<b><br>");
					  		console.log(responseMusic.data[0].from.name);
					  		for (var j = responseMusic.data.length - 1; j >= 0; j--) {
					  			var d = responseMusic.data[j].data;
					  			if(d && d.album){
					  				var item = "<a href='" + d.album.url + "'>"+d.song.title+ "</a> / " + d.album.title + " (<b>"+responseMusic.data[j].from.name+"</b>)<br>";					  				
					  				var b = results.pushUnique(item);
					  				if(b){
					  					$("#album").append(item);
					  				}
					  				
					  			}
					  		};
					  		
					  		
					  	}					  	
					  }
					});
		    	//}
		    	
		    };
		  }
		  
		});

		


		
	}

	/*
	FB.Event.subscribe('auth.authResponseChange', function(response) {    
	    if (response.status === 'connected') {      
	      getFriendsMusic();
	    } else if (response.status === 'not_authorized') {      
	      login();
	    } else {      
	      login();
	    }
  	});	
  	*/
    	
</script>
<button id="fb-auth">Login</button>
<div id="album"></div>    

</body>
</html>
